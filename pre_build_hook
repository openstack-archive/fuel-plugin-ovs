#!/bin/bash

set -eux

BUILD_FOR=${BUILD_FOR:-ubuntu}
DIR="$(dirname `readlink -f $0`)"

INCLUDE_DEPENDENCIES=${INCLUDE_DEPENDENCIES:-true}

function download_dependencies {
  if [ "$INCLUDE_DEPENDENCIES" = true ]
  then
    wget --content-disposition -N -i  "${DIR}/ovs_package/${1}/dependencies.txt"
  fi
}

function build_pkg {
  case $1 in
    ubuntu)
      pushd "${DIR}/repositories/${1}/"
      download_dependencies ${1}
      popd
      cd ${DIR}/ovs-nsh
      sudo docker build -t ovs-nsh .
      container_id=`sudo docker run -d ovs-nsh`
      sudo docker cp $container_id:/openvswitch/openvswitch-common_2.4.90-1_amd64.deb ${DIR}/repositories/ubuntu/
      sudo docker cp $container_id:/openvswitch/openvswitch-datapath-dkms_2.4.90-1_all.deb ${DIR}/repositories/ubuntu/
      sudo docker cp $container_id:/openvswitch/openvswitch-switch_2.4.90-1_amd64.deb ${DIR}/repositories/ubuntu/
      sudo docker cp $container_id:/dpdk-2.1.0.tar.gz ${DIR}/repositories/ubuntu/dpdk-install/
      sudo docker cp $container_id:/openvswitch-dpdk/openvswitch-common_2.4.91-1_amd64.deb ${DIR}/repositories/ubuntu/
      sudo docker cp $container_id:/openvswitch-dpdk/openvswitch-datapath-dkms_2.4.91-1_all.deb ${DIR}/repositories/ubuntu/
      sudo docker cp $container_id:/openvswitch-dpdk/openvswitch-switch_2.4.91-1_amd64.deb ${DIR}/repositories/ubuntu/
      sudo cat << EOF > ${DIR}/repositories/ubuntu/dpdk-install/dpdk-install.sh
      #!/bin/bash

      set -eux
      cd /etc/fuel/plugins/fuel-plugin-ovs-0.5/dpdk-install/;tar -xvzf dpdk-2.1.0.tar.gz
      cd /etc/fuel/plugins/fuel-plugin-ovs-0.5/dpdk-install/dpdk-2.1.0; make install T=x86_64-native-linuxapp-gcc
EOF
      chmod +x ${DIR}/repositories/ubuntu/dpdk-install/dpdk-install.sh
      cd ${DIR}/repositories/ubuntu/
      tar -czf dpdk-install.tar.gz dpdk-install
      sudo rm -rf dpdk-install/
      mv ${DIR}/repositories/ubuntu/dppd-prox-v021.zip ${DIR}/repositories/ubuntu/dppd-install/
      sudo cat << EOF > ${DIR}/repositories/ubuntu/dppd-install/dppd-install.sh
      #!/bin/bash

      set -eux
      sudo apt-get install -y pkg-config unzip liblua5.2-dev libpcap-dev libedit-dev libncurses5-dev libncursesw5-dev
      cd /etc/fuel/plugins/fuel-plugin-ovs-0.5/dppd-install/;unzip dppd-prox-v021.zip
      export RTE_SDK=/etc/fuel/plugins/fuel-plugin-ovs-0.5/dpdk-install/dpdk-2.1.0
      export RTE_TARGET=x86_64-native-linuxapp-gcc
      cd /etc/fuel/plugins/fuel-plugin-ovs-0.5/dppd-install/dppd-PROX-v021
      export DPPD_DIR=`pwd`
      make
EOF
      chmod +x ${DIR}/repositories/ubuntu/dppd-install/dppd-install.sh
      cd ${DIR}/repositories/ubuntu/
      tar -czf dppd-install.tar.gz dppd-install
      sudo rm -rf dppd-install/
      ;;
    *) echo "Not supported system"; exit 1;;
  esac
}

for system in $BUILD_FOR
do
  build_pkg $system
done
