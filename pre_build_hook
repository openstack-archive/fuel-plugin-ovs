#!/bin/bash

set -eux

BUILD_FOR=${BUILD_FOR:-ubuntu}
DIR="$(dirname `readlink -f $0`)"

function build_pkg {
  case $1 in
    ubuntu)
      rm -rf ${DIR}/repositories/ubuntu; mkdir -p ${DIR}/repositories/ubuntu

      cd ${DIR}/ovs_build
      sudo docker build -t ovs_build .

      rm -rf ${DIR}/deb;  mkdir -p ${DIR}/deb; chmod 777 ${DIR}/deb; cd ${DIR}/deb
      sudo docker run -v ${DIR}/deb:/deb -t  ovs_build /ovs_build/build-ovs-dpdk.sh
      tar czvf ../repositories/ubuntu/ovs-dpdk.tar.gz .; cd ..

      rm -rf ${DIR}/deb;  mkdir -p ${DIR}/deb; chmod 777 ${DIR}/deb; cd ${DIR}/deb
      sudo docker run -v ${DIR}/ovs-nsh:/deb -t  ovs_build /ovs_build/build-ovs-nsh-dpdk.sh
      tar czvf ../repositories/ubuntu/ovs-dpdk.tar.gz .; cd ..

      rm -rf ${DIR}/deb;
      ;;
    *) echo "Not supported system"; exit 1;;
  esac
}

for system in $BUILD_FOR
do
  build_pkg $system
done
