#!/bin/bash

set -eux

BUILD_FOR=${BUILD_FOR:-ubuntu}
DIR="$(dirname `readlink -f $0`)"

INCLUDE_DEPENDENCIES=${INCLUDE_DEPENDENCIES:-true}

function download_dependencies {
  if [ "$INCLUDE_DEPENDENCIES" = true ]
  then
    wget --content-disposition -N -i  "${DIR}/ovs_package/${1}/dependencies.txt"
  fi
}

function build_pkg {
  case $1 in
    ubuntu)
      pushd "${DIR}/repositories/${1}/"
      download_dependencies ${1}
      popd
      cd ${DIR}/ovs_build
      sudo docker build -t ovs_build .
      sudo docker run -v ${DIR}/repositories/ubuntu/ovs-nsh:/build -t  ovs_build /ovs_build/build-ovs-nsh.sh
      sudo docker run -v ${DIR}/repositories/ubuntu/ovs-dpdk:/build -t  ovs_build /ovs_build/build-ovs-dpdk.sh
      sudo docker run -v ${DIR}/repositories/ubuntu/ovs-nsh-dpdk:/build -t  ovs_build /ovs_build/build-ovs-nsh-dpdk.sh
      ;;
    *) echo "Not supported system"; exit 1;;
  esac
}

for system in $BUILD_FOR
do
  build_pkg $system
done
